{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/OneDrive/Documents/Coblabsite/blaffa_site/src/lib/push-notifications.ts"],"sourcesContent":["import { initializeApp, getApp, getApps } from 'firebase/app';\r\nimport { getMessaging, getToken, onMessage, Messaging } from 'firebase/messaging';\r\nimport api from './axios';\r\n\r\nconst firebaseConfig = {\r\n    apiKey: \"AIzaSyCpYf8cR98sJ9Vw12ARlXFUqJyy3PSI1Vg\",\r\n    authDomain: \"betpay-509eb.firebaseapp.com\",\r\n    projectId: \"betpay-509eb\",\r\n    storageBucket: \"betpay-509eb.firebasestorage.app\",\r\n    messagingSenderId: \"827338495555\",\r\n    appId: \"1:827338495555:web:9949d7c2caffe2b599e6f6\",\r\n    vapidKey: \"BFHKpREc3F52Eb4uBMUMmfuQQBj7yd_5IjXK248ZeVKO7axslH2S3s09DEo5r1zwQ3Apz4xZnNiyNBmx3vVNv38\"\r\n};\r\n\r\nlet isInitialized = false;\r\n\r\n/**\r\n * Registry device on backend\r\n */\r\nasync function registerDeviceOnBackend(token: string, type: 'web' | 'android' | 'ios') {\r\n    try {\r\n        const accessToken = localStorage.getItem('accessToken');\r\n        if (!accessToken) {\r\n            console.log('‚ö†Ô∏è [TEST LOG] No access token found, skipping backend registration');\r\n            return;\r\n        }\r\n\r\n        console.log(`üì± [TEST LOG] Registering device on backend with token: ${token.substring(0, 10)}...`);\r\n        await api.post(\r\n            `/blaffa/devices/`,\r\n            { registration_id: token, type },\r\n            { headers: { 'Content-Type': 'application/json' } }\r\n        );\r\n        console.log('‚úÖ [TEST LOG] Device registered successfully on backend');\r\n    } catch (error) {\r\n        console.error('‚ùå [TEST LOG] Error registering device on backend:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Initialize Push Notifications for Web using Firebase\r\n */\r\nexport async function initializePushNotifications(): Promise<void> {\r\n    console.log('üöÄ [TEST LOG] initializePushNotifications() called at:', new Date().toISOString());\r\n\r\n    // Ne pas initialiser plusieurs fois\r\n    if (isInitialized) {\r\n        console.log('‚ö†Ô∏è [TEST LOG] Push notifications already initialized, skipping...');\r\n        return;\r\n    }\r\n\r\n    console.log('üîç [TEST LOG] Checking platform compatibility...');\r\n\r\n    // Sur le web, on v√©rifie si le navigateur supporte les Service Workers et le Push\r\n    if (typeof window === 'undefined' || !('serviceWorker' in navigator) || !('PushManager' in window)) {\r\n        console.log('‚ùå [TEST LOG] Push notifications not available on this browser - exiting');\r\n        return;\r\n    }\r\n\r\n    console.log(`‚úÖ [TEST LOG] Initializing push notifications on web platform (loading from remote URL)`);\r\n    console.log(`‚ÑπÔ∏è [TEST LOG] Navigator serviceWorker available: true`);\r\n\r\n    try {\r\n        // V√©rifier d'abord l'√©tat actuel des permissions\r\n        console.log('üîê [TEST LOG] Checking current push notification permissions...');\r\n        let permStatus = Notification.permission;\r\n        console.log('üîê [TEST LOG] Current permission status:', permStatus);\r\n\r\n        // Si la permission n'a pas encore √©t√© demand√©e (default), la demander\r\n        if (permStatus === 'default') {\r\n            console.log('üìã [TEST LOG] Requesting push notification permissions...');\r\n            permStatus = await Notification.requestPermission();\r\n            console.log('üìã [TEST LOG] Permission request result:', permStatus);\r\n        } else if (permStatus === 'denied') {\r\n            console.warn('üö´ [TEST LOG] Push notification permission denied by user. User can enable it in browser settings.');\r\n            return;\r\n        } else if (permStatus === 'granted') {\r\n            console.log('‚úÖ [TEST LOG] Push notification permission already granted');\r\n        }\r\n\r\n        // V√©rifier si la permission a √©t√© accord√©e avant de continuer\r\n        if (permStatus !== 'granted') {\r\n            console.warn('üö´ [TEST LOG] Push notification permission not granted:', permStatus);\r\n            return;\r\n        }\r\n\r\n        console.log('‚úÖ [TEST LOG] Push notification permission granted, setting up Firebase Messaging...');\r\n\r\n        // Initialiser Firebase (si pas d√©j√† fait)\r\n        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();\r\n        const messaging = getMessaging(app);\r\n\r\n        // Sur Android avec Capacitor, on cr√©e un canal. Sur le web, on simule l'initialisation du canal \"blaffa\"\r\n        console.log('‚úÖ [TEST LOG] High priority notification channel \"blaffa\" configured for web');\r\n\r\n        console.log('üëÇ [TEST LOG] Adding push notification event listeners...');\r\n\r\n        // √âcouter les messages re√ßus au premier plan\r\n        onMessage(messaging, (payload) => {\r\n            console.log('üì® [TEST LOG] Push notification received while app in foreground:', {\r\n                title: payload.notification?.title,\r\n                body: payload.notification?.body,\r\n                data: payload.data,\r\n                timestamp: new Date().toISOString(),\r\n            });\r\n\r\n            // Afficher une notification locale via le Service Worker registration\r\n            navigator.serviceWorker.ready.then((registration) => {\r\n                registration.showNotification(payload.notification?.title || 'Notification', {\r\n                    body: payload.notification?.body || '',\r\n                    icon: '/logo.png', // Chemin vers votre ic√¥ne\r\n                    data: payload.data,\r\n                });\r\n                console.log('‚úÖ [TEST LOG] Local notification shown for foreground push notification');\r\n            });\r\n        });\r\n\r\n        console.log('üìù [TEST LOG] Requesting FCM registration token...');\r\n        const fcmToken = await getToken(messaging, {\r\n            vapidKey: firebaseConfig.vapidKey,\r\n        });\r\n\r\n        if (fcmToken) {\r\n            console.log('üîî [TEST LOG] Push registration success! Token received:', {\r\n                token_preview: fcmToken.substring(0, 30) + '...',\r\n                full_token_length: fcmToken.length,\r\n                timestamp: new Date().toISOString(),\r\n            });\r\n\r\n            console.log(`üì± [TEST LOG] Platform detected: web, preparing to send token to backend...`);\r\n            await registerDeviceOnBackend(fcmToken, 'web');\r\n        } else {\r\n            console.warn('‚ö†Ô∏è [TEST LOG] No registration token received from FCM');\r\n        }\r\n\r\n        isInitialized = true;\r\n        console.log('‚úÖ [TEST LOG] Push notifications registration initiated successfully!');\r\n\r\n    } catch (error) {\r\n        console.error('Error initializing push notifications:', error);\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}